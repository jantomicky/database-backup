#!/bin/bash

file_my_cnf="$HOME/my.cnf"
file_config="database-backup.config"

function source_config {
    if [ ! -f "$file_config" ]; then
        echo "Missing configuration file ($file_config)"
        exit 1
    fi
    if ! grep -q "PATH_DATABASE_BACKUPS" "$file_config"; then
        echo "The configuration file does not contain the backups directory path"
        exit 1
    fi
    source $file_config
}

function backup {
    mkdir -p "$PATH_DATABASE_BACKUPS"
    timestamp = $(date +"%Y-%m-%d_%H%M")
    mysqldump --defaults-file="$file_my_cnf" --all-databases | gzip > "$PATH_DATABASE_BACKUPS/$timestamp.sql.gz"
    chmod -R 600 "$PATH_DATABASE_BACKUPS/*"
}

function cleanup {
    if [[ -z "${KEEP_FOR_DAYS}" ]]; then
        echo "Skipping the cleanup of backups as the number of days for keeping them is not configured"
    else
        echo "Cleaning up backups older than $KEEP_FOR_DAYS days"
        find "$PATH_DATABASE_BACKUPS/*.sql.gz" -mtime +$KEEP_FOR_DAYS -type f -delete
    fi
}

source_config
backup
cleanup
